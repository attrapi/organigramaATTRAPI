<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>Organigrama — ATTRAPI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --stroke:#e5e7eb; --text:#0f172a; --muted:#475569;
      --pill:#f3e7eb; --shadow:0 10px 28px rgba(15,23,42,.08);
      --brand:#691c32; --ana1:#69631C; --ana2:#1C5669; --ana3:#BE7288; --ana4:#B3DBE8;
      --top1:#16a34a; --top2:#8b5cf6; --top3:#ec4899; --top4:#f59e0b; --top5:#f97316; --top6:#ef4444;
      --top7:#64748b; --top8:#14b8a6; --top9:#3b82f6;
      --match:var(--brand);
      --accent:#3b82f6;
    }
    [data-theme="dark"]{
      --bg:#0b1220; --card:#0f172a; --stroke:#1f2937; --text:#e5e7eb; --muted:#94a3b8; --pill:#1f2937; --shadow:0 12px 32px rgba(0,0,0,.35);
      --brand:#f472b6; --ana1:#f59e0b; --ana2:#22d3ee; --ana3:#a3e635; --ana4:#38bdf8;
      --top1:#22c55e; --top2:#a78bfa; --top3:#f472b6; --top4:#fbbf24; --top5:#fb923c; --top6:#f87171;
      --top7:#94a3b8; --top8:#14b8a6; --top9:#60a5fa;
    }

    /* Modo institucional */
    [data-institutional="on"] header{ background:#691c32 !important; border-bottom-color:#691c32 !important; color:#fff; }
    [data-institutional="on"] header h1{ color:#fff; }
    [data-institutional="on"] .btn{
      background:rgba(255,255,255,.12) !important; color:#fff !important; border-color:rgba(255,255,255,.28) !important;
    }
    [data-institutional="on"] .search{ background:rgba(255,255,255,.12) !important; border-color:rgba(255,255,255,.28) !important; }
    [data-institutional="on"] .search input{ color:#fff !important; }
    [data-institutional="on"] .badge-bg{ fill:rgba(105,28,50,.10); stroke:rgba(105,28,50,.28); }
    [data-institutional="on"] .badge-text{ fill:#691c32; }
    [data-institutional="on"] .node-rect{ stroke:rgba(105,28,50,.22); }
    [data-institutional="on"] .btn:hover{
      background:rgba(255,255,255,.20) !important; border-color:rgba(255,255,255,.48) !important;
      transform: translateY(-1px) scale(1.035); box-shadow: 0 6px 14px rgba(0,0,0,.18);
    }

    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    header{
      padding:12px 16px;position:sticky;top:0;z-index:5;background:rgba(255,255,255,.92);
      backdrop-filter:blur(6px);border-bottom:1px solid var(--stroke);display:flex;gap:10px;align-items:center;flex-wrap:wrap
    }
    [data-theme="dark"] header{ background:rgba(15,23,42,.85); }
    h1{font-size:16px;margin:0}
    .toolbar{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    .btn{
      padding:8px 12px;border:1px solid var(--stroke);border-radius:10px;background:#fff;font-weight:600;cursor:pointer;
      transform: translateY(0) scale(1);
      transition:background-color .18s,border-color .18s,box-shadow .18s,transform .16s cubic-bezier(.2,.8,.2,1);
      will-change: transform, box-shadow, background-color, border-color;
      text-decoration:none;
    }
    /* >>> FIX: evita azul/morado en links (Trenes) */
    a.btn, a.btn:visited{ color: inherit; }
    /* <<< FIN FIX */

    [data-theme="dark"] .btn{ background:#111827; color:#e5e7eb; border-color:#1f2937; }
    .btn:hover{ background:#f8fafc; border-color:#cbd5e1; transform: translateY(-1px) scale(1.035); box-shadow:0 8px 18px rgba(2,6,23,.10); }
    .btn:active{ transform:translateY(0) scale(0.997); box-shadow: inset 0 2px 0 rgba(0,0,0,.04); }
    .btn:focus-visible{ outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,.35); }

    /* Hover botones header en modo oscuro */
    [data-theme="dark"] header .btn:not(.fancy):hover{
      background:#1f2937 !important;
      border-color:#334155 !important;
      color:#e5e7eb !important;
    }

    .search{display:flex;gap:8px;align-items:center;background:#fff;padding:6px;border:1px solid var(--stroke);border-radius:12px}
    [data-theme="dark"] .search{ background:#0b1220; }
    .search input{border:none;outline:none;font:600 14px ui-sans-serif,system-ui;min-width:180px;background:transparent;color:var(--text)}

    .note{ flex-basis:100%; text-align:right; font-weight:600; font-size:12.5px; color:var(--muted); margin-top:4px; }
    .note .short{ display:none; }
    [data-institutional="on"] .note{ color:#fff; opacity:.9; }

    #chart{height:calc(100vh - 132px);width:100vw;overflow:hidden;position:relative}
    #results{padding:8px 16px;border-top:1px solid var(--stroke);background:#fff;display:flex;gap:8px;flex-wrap:wrap}
    [data-theme="dark"] #results{ background:#0b1220; }
    .chip{display:inline-flex;align-items:center;gap:8px;background:#f1f5f9;color:#0f172a;border:1px solid #e2e8f0;padding:6px 10px;border-radius:999px;cursor:pointer}
    [data-theme="dark"] .chip{ background:#111827;color:#e5e7eb;border-color:#374151; }
    svg{width:100%;height:100%}
    .links,.links-halo{pointer-events:none}
    .link-halo{fill:none;stroke:#ffffff;stroke-width:10px;stroke-linecap:round;opacity:.96}
    [data-theme="dark"] .link-halo{ stroke:rgba(15,23,42,.85); }
    .link{fill:none;stroke-width:2.8px;stroke-linecap:round;opacity:.98}
    .node{pointer-events:all}
    .node-card{filter:drop-shadow(0 8px 18px rgba(2,6,23,.06))}
    [data-theme="dark"] .node-card{ filter:drop-shadow(0 10px 20px rgba(0,0,0,.4)); }
    .node-rect{fill:var(--card);stroke:var(--stroke);stroke-width:1px;rx:12;ry:12}
    .node-title{font-weight:750;font-size:14px;fill:var(--text)}
    .node-sub{font-size:12px;fill:#64748b}
    [data-theme="dark"] .node-sub{ fill:#94a3b8; }
    .hit{fill:transparent;cursor:pointer}

    .badge{pointer-events:none}
    .badge-bg{fill:var(--pill);stroke:#ead1d8;stroke-width:1px;rx:8;ry:8}
    [data-theme="dark"] .badge-bg{ stroke:#334155; }
    .badge-text{fill:#5b1b2f;font-weight:800;font-size:10.7px;letter-spacing:.35px;text-transform:uppercase}
    [data-theme="dark"] .badge-text{ fill:#e5e7eb; }
    .count-tx{fill:#fff;font-weight:800;font-size:10px;dominant-baseline:middle;text-anchor:middle}

    .is-match .node-rect{stroke:var(--match);stroke-width:2.5px;filter:drop-shadow(0 6px 14px rgba(105,28,50,.18))}
    #no-data{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#64748b;font-weight:700}
    [data-theme="dark"] #no-data{ color:#94a3b8; }

    @keyframes pulseRing { 0%{box-shadow:0 0 0 0 rgba(105,28,50,.42)} 70%{box-shadow:0 0 0 12px rgba(105,28,50,0)} 100%{box-shadow:0 0 0 0 rgba(105,28,50,0)} }
    .is-highlight .node-rect{ stroke: var(--match); stroke-width: 3px; animation: pulseRing 1.2s ease-out 0s 2; }

    .hint{
      position:absolute; left:16px; bottom:12px; z-index:4; background:rgba(255,255,255,.92);
      border:1px solid var(--stroke); color:var(--muted); padding:6px 10px; border-radius:10px; font-weight:700; font-size:12.5px;
      backdrop-filter: blur(6px); animation: hintAttention 10s ease-out forwards;
    }
    [data-theme="dark"] .hint{ background: rgba(15,23,42,.85); }
    .hint.no-export{ display:none !important; }
    @media print{ .hint{ display:none !important; } }
    @keyframes hintAttention{
      0%{opacity:1; transform: translateY(0) scale(1.02); box-shadow: 0 12px 28px rgba(2,6,23,.18), 0 0 0 0 rgba(59,130,246,.60);}
      6%{transform: translateY(-3px) scale(1.04); box-shadow:0 12px 28px rgba(2,6,23,.22), 0 0 0 16px rgba(59,130,246,0);}
      12%{transform: translateY(0) scale(1.02); box-shadow:0 12px 28px rgba(2,6,23,.18), 0 0 0 0 rgba(59,130,246,.55);}
      18%{transform: translateY(-2px) scale(1.03); box-shadow:0 12px 28px rgba(2,6,23,.20), 0 0 0 12px rgba(59,130,246,0);}
      40%{opacity:.95; transform: translateY(0) scale(1);}
      80%{opacity:.50;}
      100%{opacity:0; pointer-events:none;}
    }

    .btn.fancy{ width:170px;height:38px;border-radius:24px;border:3px solid #ff304f;background:none;display:flex;align-items:center;justify-content:center;gap:6px;overflow:hidden;transition: transform .16s cubic-bezier(.2,.8,.2,1), box-shadow .18s ease;}
    .btn.fancy .lbl, .btn.fancy svg{ position:absolute; letter-spacing:1.2px; font-weight:800; text-transform:uppercase; color:#002651; fill:transparent; }
    .btn.fancy svg{ width:20px; height:20px; }
    .btn.fancy:hover{ transform: translateY(-1px) scale(1.04); box-shadow: 0 8px 18px rgba(2,6,23,.10); }
    .btn.fancy.animating{ width:54px; border-left:3px solid #1e2a78; border-bottom:3px solid #1e2a78; animation: spin 1800ms 200ms forwards ease-in-out; }
    .btn.fancy.animating .lbl{ color: transparent; }
    .btn.fancy.animating svg{ animation: check 500ms 1800ms forwards ease-out; }
    @keyframes spin { 80%{border:3px solid transparent;border-left:3px solid #303a52;} 100%{transform: rotate(1080deg); border:3px solid #303a52;} }
    @keyframes check { to { fill:#17b978; } }
    @media (max-width:768px){ header{gap:8px;} .search input{min-width:140px;} .toolbar .btn.hide-m{display:none!important} .note .full{display:none} .note .short{display:inline} }
    [data-theme="dark"] .btn.fancy .lbl, [data-institutional="on"] .btn.fancy .lbl { color:#fff !important; }

    /* Badges & tooltip */
    .attr-badge rect, .proc-badge rect{ fill: var(--brand); rx:10px; }
    .attr-badge text, .proc-badge text{ fill:#fff; font-size:11px; font-weight:700; }
    .attr-badge, .proc-badge{ cursor:pointer }

    .attr-tooltip{
      position:absolute; display:none; z-index:6; max-width:360px; min-width:260px;
      background: var(--card); color: var(--text);
      border: 1px solid var(--stroke); border-radius: 12px; box-shadow: var(--shadow);
      padding: 12px 14px; line-height: 1.35; pointer-events:auto;
    }
    .attr-tooltip h4{ margin:0 0 8px; font-size:13px }
    .attr-tooltip ol{ margin:0; padding-left:18px; max-height:260px; overflow:auto }
    .attr-tooltip li{ margin:6px 0; font-size:12.5px }
    .attr-tooltip code{ font-family: ui-monospace, Menlo, Consolas, "Liberation Mono", monospace; font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <h1>Organigrama · ATTRAPI</h1>

    <div class="search">
      <input id="q" list="acro-list" placeholder="Buscar por acrónimo o nombre…" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" />
      <datalist id="acro-list"></datalist>
      <button class="btn" id="btn-search">Buscar</button>
      <button class="btn" id="btn-clear">Limpiar</button>
    </div>

    <div class="toolbar">
      <!-- Trenes ANTES de Modo institucional -->
      <button class="btn hide-m" id="btn-trenes" type="button" title="Ir a Trenes">Trenes</button>


      <button class="btn hide-m" id="btn-inst" title="Aplicar colores institucionales">Modo institucional</button>

      <!-- Toggle global de tooltips A/P -->
      <button class="btn hide-m" id="btn-tooltips" title="Mostrar/ocultar badges de Atribuciones y Procedimientos">Atribuciones y Procedimientos</button>

      <button class="btn hide-m" id="btn-expand">Expandir todo</button>
      <button class="btn hide-m" id="btn-collapse">Colapsar todo</button>

      <button class="btn fancy noselect" id="btn-download" title="Descargar PDF del organigrama">
        <span class="lbl">Descargar PDF</span>
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M0 11c2.761.575 6.312 1.688 9 3.438 3.157-4.23 8.828-8.187 15-11.438-5.861 5.775-10.711 12.328-14 18.917-2.651-3.766-5.547-7.271-10-10.917z"/></svg>
      </button>
    </div>

    <div class="note">
      <span class="full">Dirección de Procesos Administrativos de Obras | Subdirección de Implementación de Manuales y Procedimientos de Obra</span>
      <span class="short">DPAO | SIMPO</span>
    </div>
  </header>

  <div id="results" title="Resultados de búsqueda (clic para enfocar)"></div>
  <div id="chart">
    <div id="no-data" style="display:none">Pega tu data</div>
    <div class="hint">Haz clic fuera del organigrama y arrastra para ajustar la posición. Usa la rueda para hacer zoom.</div>
  </div>

  <script>
    window.ARTF_DATA = {
      "name": "Titular de la Agencia",
      "acrónimo": "Titular",
      "children": [
        {
          "name": "Unidad de Economía, Información y Regulación Ferroviaria",
          "acrónimo": "UEIRF",
          "children": [
            { "name": "Enlace Administrativo de la Dirección General de Economía, Información, y Regulación Ferroviaria", "acrónimo": "EADGEIRF"},
            {
              "name": "Dirección de Regulación Económica", "acrónimo": "DRE",
              "children": [
                {
                  "name": "Subdirección de Contraprestaciones y Bases de Regulación Tarifaria", "acrónimo": "SCBRT",
                  "children": [
                    {"name": "Jefatura de Departamento de Contraprestaciones y Bases de Regulación Tarifaria", "acrónimo": "JDCBRT"}
                  ]
                },
                {
                  "name": "Subdirección de Tarifas de Pasajeros, Carga y Servicios Diversos", "acrónimo": "STPCSD",
                  "children": [
                    {"name": "Jefatura de Departamento de Tarifas de Pasajeros, Carga y Servicios Diversos", "acrónimo": "JDTPCSD"}
                  ]
                }
              ]
            },
            {
              "name": "Dirección de Evaluación Económica y Financiera", "acrónimo": "DEEF",
              "children": [
                {"name": "Subdirección de Evaluación Económica", "acrónimo": "SEE"},
                {
                  "name": "Subdirección de Análisis Financiero", "acrónimo": "SAF",
                  "children": [
                    {"name": "Jefatura de Departamento de Análisis Financiero", "acrónimo": "JDAF"}
                  ]
                }
              ]
            },
            {
              "name": "Dirección de Regulación Técnica Ferroviaria", "acrónimo": "DRTF",
              "children": [
                {
                  "name": "Subdirección de Regulación de la Operación Ferroviaria", "acrónimo": "SROF",
                  "children": [
                    {"name": "Jefatura de Departamento de Regulación Técnica Ferroviaria", "acrónimo": "JDRTF"}
                  ]
                },
                {
                  "name": "Subdirección de Infraestructura Ferroviaria", "acrónimo": "SIF",
                  "children": [
                    {"name": "Jefatura de Departamento de Regulación de Infraestructura", "acrónimo": "JDRI"}
                  ]
                }
              ]
            },
            {
              "name": "Dirección de Información y Estadística Ferroviaria", "acrónimo": "DIEF",
              "children": [
                {
                  "name": "Subdirección de Estadística Ferroviaria", "acrónimo": "SEF",
                  "children": [
                    {"name": "Jefatura de Departamento de Estadística Ferroviaria", "acrónimo": "JDEF"},
                    {"name": "Enlace de Información", "acrónimo": "EI"},
                    {"name": "Enlace de Estadística", "acrónimo": "EE"}
                  ]
                }
              ]
            }
          ]
        },
        {
          "name": "Unidad de Verificación, Supervisión y Registro", "acrónimo": "UVSR",
          "children": [
            { "name": "Enlace Administrativo de la Dirección General de Verificación, Supervisión y Registro", "acrónimo": "EADGVSR" },
            { "name": "Subdirección de Coordinación con Centros SICT", "acrónimo": "SCCSICT" },
            { "name": "Subdirección de Análisis de la Operación y Seguridad", "acrónimo": "SAOS"},
            { "name": "Enlace de Operación y Seguridad", "acrónimo": "EOS" },
            {
              "name": "Dirección de Verificación y Supervisión Ferroviaria \"A\"", "acrónimo": "DVSFA",
              "children": [
                {"name": "Enlace de Verificación y Supervisión Ferroviaria \"A\"", "acrónimo": "EVSFA"},
                {"name": "Subdirección de Verificación y Supervisión Ferroviaria \"A\"", "acrónimo": "SVSFA"},
                {"name": "Subdirección de Verificación y Supervisión Ferroviaria \"B\"", "acrónimo": "SVSFB"},
                {"name": "Subdirección de Verificación y Supervisión Ferroviaria \"C\"", "acrónimo": "SVSFC"}
              ]
            },
            {
              "name": "Dirección de Verificación y Supervisión Ferroviaria \"B\"", "acrónimo": "DVSFB",
              "children": [
                {"name": "Enlace de Verificación y Supervisión Ferroviaria \"B\"", "acrónimo": "EVSFB"},
                {"name": "Subdirección de Verificación y Supervisión Ferroviaria \"D\"", "acrónimo": "SVSFD"},
                {"name": "Subdirección de Verificación y Supervisión Ferroviaria \"E\"", "acrónimo": "SVSFE"},
                {"name": "Subdirección de Verificación y Supervisión Ferroviaria \"F\"", "acrónimo": "SVSFF"}
              ]
            },
            {
              "name": "Dirección de Verificación y Supervisión Ferroviaria C", "acrónimo": "DVSFC",
              "children": [
                {"name": "Subdirección de Verificación y Supervisión Ferroviaria \"G\"", "acrónimo": "SVSFG"},
                {"name": "Subdirección de Verificación y Supervisión Ferroviaria \"H\"", "acrónimo": "SVSFH"}
              ]
            },
            {
              "name": "Dirección de Registro Ferroviario Mexicano", "acrónimo": "DRFM",
              "children": [
                {"name": "Subdirección de Registro Ferroviario Mexicano", "acrónimo": "SRFM"}
              ]
            },
            {
              "name": "Dirección de Seguridad Ferroviaria", "acrónimo": "DSF",
              "children": [
                {"name": "Subdirección de Seguimiento de Siniestros Ferroviarios", "acrónimo": "SSSF"},
                {"name": "Subdirección de Programas de Seguridad Ferroviaria", "acrónimo": "SPSF"}
              ]
            }
          ]
        },
        { "name": "Unidad de Planeación y Proyectos de Transporte Público", "acrónimo": "UPPTP",
          "children": [
            {
              "name": "Dirección de Estudios de Transporte", "acrónimo": "DET",
              "children": [
                {
                  "name": "Subdirección de Estudios de Demanda", "acrónimo": "SED",
                  "children": [{"name": "Jefatura de Departamento de Estudios de Demanda", "acrónimo": "JDED"}]
                },
                {"name": "Subdirección de Análisis Geográfico", "acrónimo": "SAG"},
                {
                  "name": "Subdirección de Ingeniería de Transporte Público y Vial", "acrónimo": "SITPV",
                  "children": [
                    {"name": "Jefatura de Departamento de Modelación de Transporte", "acrónimo": "JDMT"},
                    {"name": "Jefatura de Departamento de Análisis", "acrónimo": "JDA"}
                  ]
                }
              ]
            },
            {
              "name": "Dirección de Proyectos de Transporte", "acrónimo": "DPT",
              "children": [
                {
                  "name": "Subdirección de Seguimiento de Proyectos de Transporte", "acrónimo":"SSPT",
                  "children" : [
                    {"name": "Jefatura de Departamento de Diseño y Señalamiento Vial", "acrónimo": "JDDSV"},
                    {"name": "Jefatura de Departamento de Proyectos de Transporte", "acrónimo": "JDPT"}
                  ]
                },
                {
                  "name": "Subdirección de Regulación y Normatividad", "acrónimo": "SRN",
                  "children": [
                    {"name": "Jefatura de Departamento de Consulta", "acrónimo": "JDC"}
                  ]
                }
              ]
            },
            {
              "name": "Dirección de Integración de Transporte", "acrónimo": "DIT",
              "children": [
                {
                  "name": "Subdirección de Integración de Transporte", "acrónimo": "SIT",
                  "children": [
                    {"name": "Jefatura de Departamento de Transporte Modal", "acrónimo": "JDTM"},
                    {"name": "Jefatura de Departamento de Accesibilidad", "acrónimo": "JDACC"}
                  ]
                }
              ]
            },
            { "name": "Enlace de Planeación de Transporte", "acrónimo": "EPT" }
          ]
        },
        { "name": "Unidad de Proyectos Ferroviarios ", "acrónimo": "UPF",
          "children": [
            { "name": "Enlace Administrativo de la Dirección General de Proyectos Ferroviarios", "acrónimo": "EADGPF" },
            { "name": "Enlace Técnico Administrativo", "acrónimo": "ETA" },
            {
              "name": "Dirección de Proyectos Ferroviarios de Pasajeros", "acrónimo": "DPFP",
              "children": [
                {
                  "name": "Subdirección de Coordinación y Seguimiento de Proyectos Ferroviarios de Pasajeros", "acrónimo": "SCSPFP",
                  "children": [
                    {"name": "Jefatura de Departamento de Seguimiento de la Infraestructura de Proyectos Ferroviarios", "acrónimo": "JDSIPF"},
                    {"name": "Jefatura de Departamento de Diseño de Proyectos Ferroviarios", "acrónimo": "JDDPF"}
                  ]
                },
                {
                  "name": "Subdirección de Planeación y Evaluación de Proyectos Ferroviarios", "acrónimo": "SPEPF",
                  "children": [
                    {"name": "Jefatura de Departamento de Estudios de Proyectos Ferroviarios", "acrónimo": "JDEPF"},
                    {"name": "Jefatura de Departamento de Análisis Operacional de Proyectos Ferroviarios", "acrónimo": "JDAOPF"}
                  ]
                }
              ]
            },
            {
              "name": "Dirección de Proyectos Ferroviarios de Carga y Desarrollo Multimodal", "acrónimo": "DPFCDM",
              "children": [
                { "name": "Subdirección de Coordinación y Seguimiento de Proyectos Ferroviarios de Carga", "acrónimo": "SCSPFC" },
                {
                  "name": "Subdirección de Desarrollo Multimodal y de Servicios Auxiliares", "acrónimo": "SDMSA",
                  "children": [
                    {"name": "Jefatura de Departamento de Desarrollo Multimodal", "acrónimo": "JDDM"},
                    {"name": "Jefatura de Departamento de Servicios Auxiliares Ferroviarios", "acrónimo": "JDSAF"}
                  ]
                }
              ]
            }
          ]
        },
        { "name": "Unidad de Asuntos Jurídicos", "acrónimo": "UAJ",
          "children": [
            { "name": "Jefatura de Departamento de Transparencia a Acceso a la Información", "acrónimo": "JDTAI" },
            {
              "name": "Dirección de lo Consultivo", "acrónimo": "DCONS",
              "children": [
                {
                  "name": "Subdirección Jurídica de Instrumentos Regulatorios", "acrónimo": "SJIR",
                  "children": [
                    {"name": "Jefatura de Departamento de Análisis Técnico-Normativo del Sector Ferroviario", "acrónimo": "JDATNSF"}
                  ]
                },
                {
                  "name": "Subdirección de Consulta Legal", "acrónimo": "SCL",
                  "children": [
                    {"name": "Jefatura de Departamento de Contratos y Convenios", "acrónimo": "JDCC"},
                    {"name": "Jefatura de Departamento de Seguimiento a Órganos", "acrónimo": "JDSO"}
                  ]
                },
                {
                  "name": "Subdirección Jurídica de Concesiones, Asignaciones y Permisos", "acrónimo": "SJCAP",
                  "children": [
                    {"name": "Jefatura de Departamento de Análisis Jurídico de Concesiones, Asignaciones y Permisos", "acrónimo": "JDAJCAP"}
                  ]
                }
              ]
            },
            {
              "name": "Dirección de lo Contencioso", "acrónimo": "DCONT",
              "children": [
                {
                  "name": "Subdirección de Procedimientos de Sanción", "acrónimo": "SPS",
                  "children": [
                    {"name": "Jefatura de Departamento de Procedimientos Administrativos de Sanción", "acrónimo": "JDPAS"},
                    {"name": "Jefatura de Departamento de Asuntos Laborales, Civiles, Agrarios y Penales", "acrónimo": "JDALCAP"}
                  ]
                },
                {
                  "name": "Subdirección de Juicios y Controversias", "acrónimo": "SJC",
                  "children": [
                    {"name": "Jefatura de Departamento de Juicios de Nulidad y Amparo", "acrónimo": "JDJNA"}
                  ]
                }
              ]
            },
            {
              "name": "Dirección Jurídica de Coordinación de Liberación de Derecho de Vía", "acrónimo": "DJCLDV",
              "children": [
                {
                  "name": "Subdirección Jurídica de Integración de Expedientes de Derecho de Vía", "acrónimo": "SJIEDV",
                  "children":[
                    {
                      "name": "Jefatura de Departamento Jurídico de Integración de Expedientes de Derecho de Vía", "acrónimo": "JDJIEDV",
                      "children": [
                        {"name": "Enlace Jurídico de Integración de Expedientes de Derecho de Vía", "acrónimo": "EJIEDV"}
                      ]
                    }
                  ]
                },
                {
                  "name": "Subdirección Jurídica de Coordinación y Gestión de Derecho de Vía", "acrónimo": "SJCGDV",
                  "children": [
                    {"name": "Jefatura de Departamento Jurídico de Coordinación de Gestión de Derechos de Vía", "acrónimo": "JDJCGDV"}
                  ]
                }
              ]
            },
            {
              "name": "Dirección Jurídica de Obras", "acrónimo": "DJO",
              "children": [
                {
                  "name": "Subdirección de Gestión Jurídica de Obras", "acrónimo": "SGJO",
                  "children": [
                    {"name": "Jefatura de Departamento de Gestión Jurídica de Obras A", "acrónimo": "JDGJOA"},
                    {"name": "Jefatura de Departamento de Gestión Jurídica de Obras B", "acrónimo": "JDGJOB"}
                  ]
                },
                {
                  "name": "Subdirección de Gestión Técnica y Seguimiento a Órganos de Control de Obras", "acrónimo": "SGTSOCO",
                  "children": [
                    {"name": "Jefatura de Departamento de Gestión Técnica de Obras", "acrónimo": "JDGTO"},
                    {"name": "Jefatura de Departamento de Seguimiento en Materia de Obras a Órganos Fiscalizadores", "acrónimo": "JDSMOOF"}
                  ]
                }
              ]
            }
          ]
        },
        { "name": "Unidad de Administración y Finanzas", "acrónimo": "UAF",
          "children": [
            { "name": "Enlace Administrativo de la Dirección General de Administración y Finanzas ", "acrónimo": "EADGAF" },
            {
              "name": "Dirección de Recursos Materiales y Servicios Generales", "acrónimo": "DRMSG",
              "children": [
                {
                  "name": "Subdirección de Servicios Generales", "acrónimo": "SSG",
                  "children": [
                    {
                      "name": "Jefatura de Departamento de Almacenes e Inventarios", "acrónimo": "JDAI",
                      "children": [
                        {"name": "Enlace Control de Almacenes e Inventarios", "acrónimo": "ECAI"}
                      ]
                    }
                  ]
                },
                {
                  "name": "Subdirección de Recursos Materiales, Procedimientos y Contratos", "acrónimo": "SRMPC",
                  "children": [
                    {
                      "name": "Jefatura de Departamento de Procedimientos", "acrónimo": "JDP",
                      "children": [
                        {"name": "Enlace de Procedimientos", "acrónimo": "EP"},
                        {"name": "Enlace de Recursos Materiales", "acrónimo": "ERM"}
                      ]
                    },
                    {
                      "name": "Jefatura de Departamento de Contratos", "acrónimo": "JDCO",
                      "children": [
                        {"name": "Enlace de Contratos", "acrónimo": "EC"}
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "Dirección de Recursos Financieros", "acrónimo": "DRF",
              "children": [
                {
                  "name": "Subdirección de Presupuesto", "acrónimo": "SPR",
                  "children": [
                    {"name": "Enlace al Presupuesto", "acrónimo": "EPR"}
                  ]
                },
                {
                  "name": "Subdirección de Contabilidad y Pagos", "acrónimo": "SCP",
                  "children": [
                    {"name": "Enlace de Contabilidad y Pagos", "acrónimo": "ECP"}
                  ]
                }
              ]
            },
            {
              "name": "Dirección de Recursos Humanos", "acrónimo": "DRRHH",
              "children": [
                {
                  "name": "Subdirección de Recursos Humanos y Relaciones Laborales", "acrónimo": "SRHRL",
                  "children": [
                    {"name": "Enlace de Recursos Humanos", "acrónimo": "ERH"},
                    {"name": "Enlace de Relaciones Laborales", "acrónimo": "ERL"}
                  ]
                }
              ]
            },
            {
              "name": "Dirección de Tecnologías de La Información y de Proyectos", "acrónimo": "DTIP",
              "children": [
                {
                  "name": "Subdirección de Sistemas de Información", "acrónimo": "SSI",
                  "children": [
                    {"name": "Jefatura de Departamento de Especialista de Pruebas", "acrónimo": "JDEP"},
                    {"name": "Jefatura de Departamento de Desarrollo de Sistemas de Información", "acrónimo": "JDDSI"},
                    {
                      "name": "Jefatura de Departamento de Administración de Sistemas de Información", "acrónimo": "JDASI",
                      "children": [
                        {"name": "Enlace Soporte Técnico e Infraestructura Informática", "acrónimo": "ESTII"},
                        {"name": "Enlace a Redes y Comunicaciones", "acrónimo": "ERC"}
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "Dirección Financiera de Obras", "acrónimo": "DFO",
              "children": [
                {
                  "name": "Subdirección de Recursos Materiales y Servicios Generales de Obras", "acrónimo": "SRMSGO",
                  "children": [
                    {"name": "Jefatura de Departamento de Recursos Materiales de Obras", "acrónimo": "JDRMO"},
                    {"name": "Jefatura de Departamento de Servicios Generales de Obras", "acrónimo": "JDSGO"}
                  ]
                },
                {
                  "name": "Subdirección de Administración y Recursos Financieros de Obras", "acrónimo": "SARFO",
                  "children": [
                    {"name": "Jefatura de Departamento de Administración de Obras ", "acrónimo": "JDAO"},
                    {"name": "Jefatura de Departamento de Recursos Financieros de Obras", "acrónimo": "JDRFO"}
                  ]
                }
              ]
            }
          ]
        },
        {
          "name": "Unidad de Seguimiento a Proyectos y Asuntos Estratégicos", "acrónimo": "USPAE",
          "children": [
            {
              "name": "Coordinación de Relaciones Institucionales con Asignatarios y Concesionarios", "acrónimo": "CRIAC",
              "children": [
                {"name": "Subdirección de Vinculación con Asignatarios y Concesionarios", "acrónimo": "SVAC"}
              ]
            },
            {
              "name": "Dirección de Programación de Proyectos Estratégicos", "acrónimo": "DPPE",
              "children": [
                {"name": "Subdirección de Programación y Seguimiento de Proyectos Estratégicos \"A\" ", "acrónimo": "SPSPEA"},
                {"name": "Subdirección de Programación y Seguimiento de Proyectos Estratégicos \"B\" ", "acrónimo": "SPSPEB"},
                {"name": "Subdirección de Programación y Seguimiento de Proyectos Estratégicos \"C\" ", "acrónimo": "SPSPEC"}
              ]
            },
            {
              "name": "Dirección de Coordinación Técnica y Seguimiento de Proyectos", "acrónimo": "DCTSP",
              "children": [
                {"name": "Jefatura de Análisis Técnico de Proyectos", "acrónimo": "JATP"},
                {"name": "Enlace de Gestión", "acrónimo": "EG"},
                {"name": "Subdirección de Coordinación Técnica de Proyectos \"A\"", "acrónimo": "SCTPA"},
                {"name": "Subdirección de Coordinación Técnica de Proyectos \"B\"", "acrónimo": "SCTPB"},
                {
                  "name": "Subdirección de Seguimientos de Proyectos", "acrónimo": "SSP",
                  "children": [
                    {"name": "Jefatura de Departamento de Seguimiento de Proyectos \"A\"", "acrónimo": "JDSPA"},
                    {"name": "Jefatura de Departamento de Seguimiento de Proyectos \"B\"", "acrónimo": "JDSPB"}
                  ]
                }
              ]
            }
          ]
        },
        {
          "name": "Secretario Particular", "acrónimo": "SP",
          "children": [
            {
              "name": "Subdirección de Control Institucional", "acrónimo": "SCI",
              "children": [
                {"name": "Enlace Logístico", "acrónimo":"EL"}
              ]
            },
            {
              "name": "Subdirección de Control de Gestión", "acrónimo": "SCG",
              "children": [
                {"name": "Jefatura de Departamento de Atención Ciudadana", "acrónimo":"JDAC"},
                {"name": "Jefatura de Departamento de Control de Gestión y Registro", "acrónimo":"JDCGR"}
              ]
            }
          ]
        },
        {
          "name": "Unidad Técnica", "acrónimo": "UT",
          "children": [
            {
              "name": "Subdirección de Control Documental Técnica", "acrónimo": "SCDT",
              "children": [
                {"name": "Enlace de Control Documental", "acrónimo": "ECD"}
              ]
            },
            {
              "name": "Dirección de Planeación y Programación de Obras", "acrónimo": "DPPO",
              "children": [
                { "name": "Subdirección de Planeación y Programación de Obras", "acrónimo": "SPPO" },
                { "name": "Jefatura de Departamento de Programación", "acrónimo": "JDPR" }
              ]
            },
            {
              "name": "Dirección de Diseño y Proyecto", "acrónimo": "DDP",
              "children": [
                {
                  "name": "Subdirección de Diseño de Ingeniería y Proyecto", "acrónimo": "SDIP",
                  "children": [
                    {"name": "Jefatura de Departamento de Ingeniería y Proyecto", "acrónimo": "JDIP"}
                  ]
                },
                {
                  "name": "Subdirección de Ingeniería Ferroviaria", "acrónimo": "SINF",
                  "children": [
                    {"name": "Jefatura de Departamento de Ingeniería Ferroviaria", "acrónimo": "JDIF"}
                  ]
                }
              ]
            },
            {
              "name": "Dirección de Material Rodante y Sistemas Ferroviarios", "acrónimo": "DMRSF",
              "children": [
                {"name": "Subdirección de Material Rodante", "acrónimo": "SMR"},
                {"name": "Subdirección de Sistemas Ferroviarios y Mantenimiento", "acrónimo": "SSFM"}
              ]
            }
          ]
        },
        {
          "name": "Unidad de Construcción", "acrónimo": "UO",
          "children": [           
             {
              "name": "Subdirección de Oficina Técnica y Proyecto", "acrónimo": "SOTP",
              "children": [
                {"name": "Jefatura de Departamento de Oficina Técnica", "acrónimo": "JDOT"},
                {"name": "Jefatura de Departamento de Ingenierías y Proyecto", "acrónimo": "JDINP"}
              ]
            },
             {
              "name": "Subdirección de Control Documental de Construcción", "acrónimo": "SCDC",          
            },
            {
              "name": "Dirección de Ingeniería de Concursos y Costos de Obra", "acrónimo": "DICCO",
              "children": [
                {
                  "name": "Subdirección de Concursos y Costos \"A\" ", "acrónimo": "SCC\"A\"",
                  "children": [
                    {"name": "Jefatura de Departamento de Concursos y Costos \"A\"", "acrónimo": "JDCC\"A\"" }                    
                  ]
                },
                {
                  "name": "Subdirección de Concursos y Costos \"B\" ", "acrónimo": "SCC\"B\"",
                  "children": [
                    {"name": "Jefatura de Departamento de Concursos y Costos \"B\"", "acrónimo": "JDCC\"B\""}
                  ]
                },
                {
                  "name": "Subdirección de Concursos y Costos \"C\" ", "acrónimo": "SCC\"C\"",
                  "children": [
                    {"name": "Jefatura de Departamento de Concursos y Costos \"C\"", "acrónimo": "JDCC\"C\""}                    
                  ]
                },
                {
                  "name": "Subdirección de Concursos y Costos \"D\"", "acrónimo": "SCC\"D\"",
                  "children": [
                    {"name": "Jefatura de Departamento de Concursos y Costos \"D\"", "acrónimo": "JDCC\"D\""}
                  ]
                }
              ]
            },
            {
              "name": "Dirección de Construcción A", "acrónimo": "DC\"A\"",
              "children": [
                {
                "name": "Subdirección de Construcción \"A1\"", "acrónimo": "SC\"A1\"",
                  "children": [
                    {"name": "Jefatura de Departamento de Residencia de Obra \"A1-A\"", "acrónimo": "JDO\"A1A\""},
                    {"name": "Jefatura de Departamento de Residencia de Obra \"A1-B\"", "acrónimo": "JDO\"A1B\""},
                    {"name": "Jefatura de Departamento de Residencia de Obra \"A1-C\"", "acrónimo": "JDO\"A1C\""}
                  ]
                },
                {
                  "name": "Subdirección de Construcción \"A2\"", "acrónimo": "SC\"A2\"",
                  "children": [
                    {"name": "Jefatura de Departamento de Obra \"A2-A\"", "acrónimo": "JDO\"A2A\""},
                    {"name": "Jefatura de Departamento de Obra \"A2-B\"", "acrónimo": "JDO\"A2B\""},
                    {"name": "Jefatura de Departamento de Obra \"A2-C\"", "acrónimo": "JDO\"A2C\""}
                  ]
                },
                {
                  "name": "Subdirección de Construcción \"A3\"", "acrónimo": "SC\"A3\"",
                  "children": [
                    {"name": "Jefatura de Departamento de Obra \"A3-A\"", "acrónimo": "JDO\"A3A\""},
                    {"name": "Jefatura de Departamento de Obra \"A3-B\"", "acrónimo": "JDO\"A3B\""},
                    {"name": "Jefatura de Departamento de Obra \"A3-C\"", "acrónimo": "JDO\"A3C\""}
                  ]
                }
              ]
            },
            {
              "name": "Dirección de Construcción B", "acrónimo": "DCB",
              "children": [
                {
                  "name": "Subdirección de Construcción de Obras \"B1\"", "acrónimo": "SCOB1",
                  "children": [
                    {"name": "Jefatura de Departamento de Obra \"B1-A\"", "acrónimo": "JDOB1A"},
                    {"name": "Jefatura de Departamento de Obra \"B1-B\"", "acrónimo": "JDOB1B"},
                    {"name": "Jefatura de Departamento de Obra \"B1-C\"", "acrónimo": "JDOB1C"}
                  ]
                },
                {
                  "name": "Subdirección de Construcción de Obras \"B2\"", "acrónimo": "SCOB2",
                  "children": [
                    {"name": "Jefatura de Departamento de Obra \"B2-A\"", "acrónimo": "JDOB2A"},
                    {"name": "Jefatura de Departamento de Obra \"B2-B\"", "acrónimo": "JDOB2B"},
                    {"name": "Jefatura de Departamento de Obra \"B2-C\"", "acrónimo": "JDOB2C"}
                  ]
                }
              ]
            },
            {
              "name": "Dirección de Construcción C", "acrónimo": "DCC",
              "children": [
                {
                  "name": "Subdirección de Construcción de Obras \"C1\"", "acrónimo": "SCOC1",
                  "children": [
                    {"name": "Jefatura de Departamento de Obra \"C1-A\"", "acrónimo": "JDOC1A"},
                    {"name": "Jefatura de Departamento de Obra \"C1-B\"", "acrónimo": "JDOC1B"},
                    {"name": "Jefatura de Departamento de Obra \"C1-C\"", "acrónimo": "JDOC1C"}
                  ]
                },
                {
                  "name": "Subdirección de Construcción de Obras \"C2\"", "acrónimo": "SCOC2",
                  "children": [
                    {"name": "Jefatura de Departamento de Obra \"C2-A\"", "acrónimo": "JDOC2A"},
                    {"name": "Jefatura de Departamento de Obra \"C2-B\"", "acrónimo": "JDOC2B"},
                    {"name": "Jefatura de Departamento de Obra \"C2-C\"", "acrónimo": "JDOC2C"}
                  ]
                }
              ]
            },
            {
              "name": "Dirección de Construcción D", "acrónimo": "DCD",
              "children": [
                {
                  "name": "Subdirección de Construcción de Obras \"D1\"", "acrónimo": "SCOD1",
                  "children": [
                    {"name": "Jefatura de Departamento de Obra \"D1-A\"", "acrónimo": "JDOD1A"},
                    {"name": "Jefatura de Departamento de Obra \"D1-B\"", "acrónimo": "JDOD1B"}
                  ]
                },
                {
                  "name": "Subdirección de Construcción de Obras \"D2\"", "acrónimo": "SCOD2",
                  "children": [
                    {"name": "Jefatura de Departamento de Obra \"D2-A\"", "acrónimo": "JDOD2A"},
                    {"name": "Jefatura de Departamento de Obra \"D2-B\"", "acrónimo": "JDOD2B"}
                  ]
                }
              ]
            },                      
             {
              "name": "Dirección de Procesos Administrativos de Construcción", "acrónimo": "DPAC",
              "atributos": [
                "Dar seguimiento al macroproceso en materia de obra pública y servicios relacionados realizadas por las direcciones generales.",
                "Llevar un registro de los insumos y productos generados por las áreas administrativas de la Coordinación General de Construcción de Vías y Trenes derivados del macroproceso en materia de obra pública y servicios relacionados.",
                "Procesar la información y correspondencia recibida en la Coordinación para su registro y archivo.",
                "Realizar la recepción, seguimiento, distribución y asignación de la correspondencia interna y externa de la Oficina de la Dirección de Procesos Administrativos de Obras, para su atención oportuna por las Unidades Administrativas y de Apoyo Técnico-Operativo.",
                "Analizar la información de los procedimientos de obras de un proyecto ferroviario para identificar desviaciones e instruir soluciones inmediatas a puntos críticos según los objetivos establecidos.",
                "Mantener actualizados los informes emitidos por la Coordinación General de Construcción de Vías y Trenes.",
                "Las demás funciones que le sean conferidas por su superior jerárquico en el ámbito de su competencia."
              ],
              "procedimientos": [
                " PRE-ARTF-DPAO-01-25 ",
                " PRE-ARTF-DPAO-02-25 ",
                " PRE-ARTF-DPAO-03-25 ",
                " PRE-ARTF-DPAO-04-25 "
              ],
              "children": [
                {
                  "name": "Subdirección de Implementación de Manuales y Procedimientos de Obras", "acrónimo": "SIMPO",
                  "children": [
                    {"name": "Jefatura de Departamento de Implementación de Manuales y Procedimientos de Obra \"A\"", "acrónimo": "JDIMPOA"},
                    {"name": "Jefatura de Departamento de Implementación de Manuales y Procedimientos de Obra \"B\"", "acrónimo": "JDIMPOB"}
                  ]
                }
              ]
            }
          ]
        },
        
        {
          "name": "Unidad de Control y Gestión Interna de Obras", "acrónimo": "UCGIO",
          "children": [
            {
              "name": "Dirección de Gestión de Sistemas de Archivos de Obras", "acrónimo": "DGSAO",
              "children": [
                {
                  "name": "Subdirección de Archivos de Obras", "acrónimo": "SAO",
                  "children": [
                    {"name": "Jefatura de Departamento de Archivos de Obras \"A\"", "acrónimo": "JDAOA"},
                    {"name": "Jefatura de Departamento de Archivos de Obras \"B\"", "acrónimo": "JDAOB"}
                  ]
                }
              ]
            }
          ]
        }
      ]
    };
  </script>

  <script>
  (function () {
    "use strict";

    const ORG_X_OFFSET = -450;
    const dx = 66, dy = 420;
    const MAX_TEXT_W = 270, PAD_X = 16;

    // >>> NUEVO: límites globales de zoom <<<
    const ZOOM_MIN = 0.59;   // zoom mínimo (más alejado)
    const ZOOM_MAX = 2.6;    // zoom máximo (más cerca)
    // >>> FIN NUEVO <<<

    const host = document.getElementById('chart');
    const resultsEl = document.getElementById('results');
    const inputEl = document.getElementById('q');
    const listEl  = document.getElementById('acro-list');

    // Data externa
    const dataRef = (window.ARTF_DATA || (typeof data !== 'undefined' ? data : null));
    if (!dataRef || typeof dataRef !== 'object'){
      document.getElementById('no-data').style.display = 'flex';
      console.warn('Falta cargar la data (window.ARTF_DATA o const data).');
      return;
    } else {
      document.getElementById('no-data').style.display = 'none';
    }

    const svg  = d3.select(host).append('svg');
    const gRoot = svg.append('g');
    const gLinksHalo = gRoot.append('g').attr('class','links-halo');
    const gLinks     = gRoot.append('g').attr('class','links');
    const gNodes     = gRoot.append('g').attr('class','nodes');

    /* ======= Estado global: mostrar badges A/P ======= */
    let showToolBadges = false;

    // ===== Tooltip global (DIV) =====
    const tooltip = d3.select('#chart').append('div').attr('class','attr-tooltip');
    let pinned = null;
    let activeAnchorEl = null;
    let hoverOnTooltip = false;
    let hideTimer = null;

    function cancelHideTimer(){ if (hideTimer){ clearTimeout(hideTimer); hideTimer = null; } }
    function scheduleHide(delay=160){
      cancelHideTimer();
      hideTimer = setTimeout(()=>{ if (!pinned && !hoverOnTooltip) hideTooltip(); }, delay);
    }

    tooltip
      .on('mouseenter', ()=>{ hoverOnTooltip = true; cancelHideTimer(); })
      .on('mouseleave', ()=>{ hoverOnTooltip = false; if (!pinned) scheduleHide(140); });

    const tooltipVisible = () => tooltip.style('display') !== 'none';

    function hideTooltip(){
      tooltip.style('display','none').html('');
      activeAnchorEl = null;
      cancelHideTimer();
    }
    function clearPinned(){
      pinned = null;
      d3.selectAll('.attr-badge,.proc-badge').classed('pinned', false);
      hideTooltip();
    }
    function positionTooltipFor(anchorEl){
      if (!anchorEl || !anchorEl.getBoundingClientRect) return hideTooltip();
      const wrap = document.getElementById('chart').getBoundingClientRect();
      const r = anchorEl.getBoundingClientRect();
      const left = r.left - wrap.left;
      const top  = r.bottom - wrap.top + 8;
      tooltip.style('left', Math.round(left)+ 'px').style('top', Math.round(top)+ 'px');
    }
    function setTooltip(html, anchorEl, makePinned){
      tooltip.html(html).style('display','block');
      activeAnchorEl = anchorEl || null;
      positionTooltipFor(anchorEl);
      if (makePinned){ d3.select(anchorEl).classed('pinned', true); }
    }
    function getNodeGroupById(id){ return gNodes.selectAll('g.node').filter(n => n.id === id); }
    function getBadgeEl(id, type){
      const g = getNodeGroupById(id);
      if (g.empty()) return null;
      const sel = g.select(type==='attr' ? 'g.attr-badge' : 'g.proc-badge');
      return sel.empty() ? null : sel.node();
    }
    function followAnchor(){
      if (!tooltipVisible()) return;
      let anchor = activeAnchorEl;
      if (pinned){ anchor = getBadgeEl(pinned.id, pinned.type); }
      if (!anchor || !document.contains(anchor)){ clearPinned(); return; }
      positionTooltipFor(anchor);
    }

    // >>> MODIFICADO: zoom usando ZOOM_MIN/ZOOM_MAX <<<
    const zoom = d3.zoom()
      .scaleExtent([ZOOM_MIN, ZOOM_MAX])
      .on('zoom', (ev)=> {
        gRoot.attr('transform', ev.transform);
        followAnchor();
      });
    svg.call(zoom);
    // >>> FIN MODIFICADO <<<

    let HOME = null;
    function applyTransform(t, duration=420){
      svg.transition().duration(duration).ease(d3.easeCubicOut).call(zoom.transform, t);
    }

    function css(varName, fallback){ return getComputedStyle(document.documentElement).getPropertyValue(varName).trim() || fallback; }
    function getDepthPalette(){ return [css('--brand','#691c32'), css('--ana1','#69631C'), css('--ana2','#1C5669'), css('--ana3','#BE7288'), css('--ana4','#B3DBE8')]; }
    const TOP_DEFAULTS = ['#16a34a','#8b5cf6','#ec4899','#f59e0b','#f97316','#ef4444','#64748b','#14b8a6','#3b82f6'];
    function getTopPalette(){ const arr=[]; for(let i=1;i<=9;i++) arr.push(css(`--top${i}`, TOP_DEFAULTS[i-1])); return arr; }

    const tree = d3.tree().nodeSize([dx, dy]).separation((a,b)=> (a.parent===b.parent ? 1.2 : 1.6));
    const root = d3.hierarchy(dataRef); root.x0 = 0; root.y0 = 0;
    root.descendants().forEach(d => { d._children = d.children; d.children = null; });
    root.children = root._children; root._children = null;

    function wrap(sel, text, maxWidth){
      const words = (text||'').split(/\s+/).filter(Boolean);
      sel.text(null);
      let line=[], tspan = sel.append('tspan').attr('x', PAD_X);
      for (let i=0;i<words.length;i++){
        line.push(words[i]); tspan.text(line.join(' '));
        if (tspan.node().getComputedTextLength() > maxWidth){
          line.pop(); tspan.text(line.join(' '));
          line = [words[i]];
          tspan = sel.append('tspan').attr('x', PAD_X).attr('dy', 16).text(words[i]);
        }
      }
      return sel.selectAll('tspan').size();
    }

    const getAcr = d => (d?.data?.["acrónimo"] ?? d?.data?.["acronimo"] ?? "").toString().trim();
    const dataKidsCount = d => Array.isArray(d?.data?.children) ? d.data.children.length : 0;
    const hasDataKids = d => dataKidsCount(d) > 0;

    function getAtributosArrayFromData(data){
      let a = data?.atributos ?? data?.atributo ?? [];
      if (Array.isArray(a)) return a.filter(x => !!x && String(x).trim());
      if (typeof a === 'string'){
        const s = a.trim();
        return s ? [s] : [];
      }
      return [];
    }
    function getProcedimientosArrayFromData(data){
      let p = data?.procedimientos ?? data?.procedimiento ?? [];
      if (Array.isArray(p)) return p.map(x => String(x).trim()).filter(Boolean);
      if (typeof p === 'string'){
        const s = p.trim(); if(!s) return [];
        return s.split(/[\n,;]+/g).map(x => x.trim()).filter(Boolean);
      }
      return [];
    }

    function renderAtribucionesHTML(data){
      const items = getAtributosArrayFromData(data);
      const itemsHTML = items.map(x=>`<li>${x}</li>`).join('');
      const acr = data["acrónimo"] || data["acronimo"] || data.name || '';
      return `<h4>Atribuciones de <strong>${acr}</strong></h4><ol>${itemsHTML}</ol>`;
    }
    function renderProcedimientosHTML(data){
      const items = getProcedimientosArrayFromData(data);
      const itemsHTML = items.map(x=>`<li><code>${x}</code></li>`).join('');
      const acr = data["acrónimo"] || data["acronimo"] || data.name || '';
      return `<h4>Procedimientos de <strong>${acr}</strong></h4><ol>${itemsHTML}</ol>`;
    }

    function nodeColor(d){
      const BRAND = css('--brand', '#691c32');
      const isInst = document.documentElement.getAttribute('data-institutional') === 'on';
      if (isInst) return BRAND;
      const DEPTH_PAL = getDepthPalette();
      if (d.depth === 1 && d.parent){
        const siblings = (d.parent.children || d.parent._children || []);
        const idx = Math.max(0, siblings.indexOf(d));
        const topPal = getTopPalette();
        return topPal[idx % topPal.length];
      }
      const idx = Math.max(0, d.depth) % DEPTH_PAL.length;
      return DEPTH_PAL[idx];
    }

    const rightX = d => (d.y + ((d._box && d._box.w) || (MAX_TEXT_W + PAD_X*2 + 32)));
    const leftX  = d => d.y;
    const elbow = (s, t) => {
      const sx = rightX(s), sy = s.x;
      const tx = leftX(t),  ty = t.x;
      const mx = (sx + tx) / 2;
      return `M ${sx},${sy} C ${mx},${sy} ${mx},${ty} ${tx},${ty}`;
    };

    function subtreeHasNodeId(ancestor, id){
      let found = false;
      (function walk(n){
        if (n.id === id) { found = true; return; }
        const kids = (n.children || n._children) || [];
        for (const k of kids){ if (found) break; walk(k); }
      })(ancestor);
      return found;
    }
    function forceCloseIfInSubtree(ancestor){
      if (pinned && subtreeHasNodeId(ancestor, pinned.id)) clearPinned();
      if (!pinned && activeAnchorEl){
        const key = activeAnchorEl.getAttribute?.('data-key') || '';
        const idFromKey = key.split('|')[0] || '';
        if (idFromKey && subtreeHasNodeId(ancestor, idFromKey)) hideTooltip();
      }
    }

    function toggle(d){
      if (!hasDataKids(d)) return;
      const wasOpen = Array.isArray(d.children) && d.children.length;
      if (wasOpen){ d._children = d.children; d.children = null; }
      else { d.children = d._children; d._children = null; }
      if (wasOpen) forceCloseIfInSubtree(d);
    }

    function norm(s){ return (s || "").toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').toUpperCase().trim(); }
    function flattenAll(node){ const out=[]; (function w(n){ out.push(n); (n.children||n._children||[]).forEach(w); })(node); return out; }
    function findByAcr(acr){ const t=norm(acr); for (const n of flattenAll(root)){ if (norm(getAcr(n))===t) return n; } return null; }
    function shiftSubtreeY(node, delta){ if (!delta||!node) return; node.descendants().forEach(n=>{ n.x += delta; }); }
    function shiftDescendantsY(node, delta){ if (!delta||!node) return; (function w(n){ if(!n.children) return; n.children.forEach(c=>{ c.x+=delta; w(c); }); })(node); }
    function shiftSubtreeH(node, delta){ node.descendants().forEach(n=>{ n.y += delta; }); }
    function subtreeExtentX(node){ let min=+Infinity,max=-Infinity; (function w(n){ min=Math.min(min,n.x); max=Math.max(max,n.x); (n.children||[]).forEach(w); })(node); return {min,max}; }
    function descendantsExtentX_exclSelf(node){ let min=+Infinity,max=-Infinity; (function w(n){ if(!n.children) return; n.children.forEach(c=>{min=Math.min(min,c.x);max=Math.max(max,c.x); w(c);}); })(node); return {min,max}; }
    function adjustMidTier(){ const cg=findByAcr('CGCVT'); if(!cg||!cg.parent) return; const tier1Y=(cg.parent.y||0)+dy; const midY=(cg.parent.y||0)+dy/2; cg.y=midY; (cg.children||cg._children||[]).forEach(k=>{ if(cg.children) k.y=tier1Y; }); }
    function applyOneSlotDownForCGCVT(){ const cg=findByAcr('CGCVT'); if(!cg) return; if (cg.children&&cg.children.length){ shiftSubtreeY(cg, dx); } }
    function clampCGCVTChildrenBelowSP(){ const cg=findByAcr('CGCVT'); const sp=findByAcr('SP'); if(!cg||!sp) return; if(!(cg.children&&cg.children.length)) return; const spExt=subtreeExtentX(sp); const kidsExt=descendantsExtentX_exclSelf(cg); if(!isFinite(kidsExt.min)) return; const margin=dx; const minPermitido=spExt.max+margin; if(kidsExt.min<minPermitido){ shiftDescendantsY(cg, minPermitido-kidsExt.min); } }
    function separateCGCVTGrandchildren(gap=dx*2.2){ const cg=findByAcr('CGCVT'); if(!cg) return; const kids=(cg.children||cg._children||[]); if(!kids.length) return; const items=kids.map(k=>{ const ext=descendantsExtentX_exclSelf(k); if(!isFinite(ext.min)||!isFinite(ext.max)){ext.min=k.x;ext.max=k.x;} return {node:k,ext}; }).sort((a,b)=>a.ext.min-b.ext.min); for(let i=1;i<items.length;i++){ const prev=items[i-1],cur=items[i]; const needMin=prev.ext.max+gap; if (cur.ext.min<needMin) shiftDescendantsY(cur.node, needMin-cur.ext.min); } }
    function promoteChildrenOneColumnUnder(acrList){ acrList.forEach(acr=>{ const top=findByAcr(acr); if(!top) return; (top.children||top._children||[]).forEach(ch=>{ const desiredY=top.y+dy; shiftSubtreeH(ch, desiredY-ch.y); }); }); }
    function findByName(name){ const t=norm(name); for (const n of flattenAll(root)){ const nm=(n.data?.name||''); if (norm(nm)===t) return n; } return null; }
    function separateGrandchildrenUnderAcr(acr,gapPx){ const top=findByAcr(acr); if(!top) return; const children=(top.children||top._children||[]); let grandkids=[]; children.forEach(ch=>{ const arr=(ch.children||ch._children||[]); grandkids=grandkids.concat(arr); }); if(grandkids.length<2) return; grandkids.sort((a,b)=>a.x-b.x); const base=((grandkids.length-1)/2)*gapPx; grandkids.forEach((g,i)=>{ shiftSubtreeY(g, i*gapPx - base); }); }

    function update(source){
      d3.tree().nodeSize([dx, dy]).separation((a,b)=> (a.parent===b.parent ? 1.2 : 1.6))(root);

      adjustMidTier(); applyOneSlotDownForCGCVT();
      promoteChildrenOneColumnUnder(['DGT','DGO','DGCGIO']);
      separateCGCVTGrandchildren(dx * 2.2);
      clampCGCVTChildrenBelowSP();

      function nudgeAcr(acr,delta){ const n=findByAcr(acr); if(n) shiftSubtreeY(n, delta); }
      function nudgeName(name,delta){ const n=findByName(name); if(n) shiftSubtreeY(n, delta); }
      nudgeAcr('JDIMPOA', -15); nudgeAcr('JDAOA', -15); nudgeAcr('DGT', 10); nudgeAcr('EADGVSR', -10);
      nudgeAcr('SP', 3);nudgeAcr('DGT', -10);nudgeAcr('DGO', -10);nudgeAcr('DGCGIO', -10);
      separateGrandchildrenUnderAcr('DGSPAE', 10);
      nudgeAcr('SDMSA', 10); nudgeAcr('JDDPF', 10); nudgeAcr('SPEPF', 10); nudgeAcr('JDASI', 10);
      nudgeName('Jefatura de Departamento de Asuntos Laborales, Civiles, Agrarios y Penales', 20);
      nudgeAcr('SGTSOCO', 10); nudgeAcr('JDSMOOF', 10);
      nudgeAcr('CRIAC', -10); nudgeName('Coordinación de Relaciones Institucionales con Asignatarios y Concesionarios', -10);
      nudgeAcr('SPSPEB', 5); nudgeName('Subdirección de Programación y Seguimiento de Proyectos Estratégicos "B"', 5);
      nudgeAcr('SPSPEC', 10); nudgeName('Subdirección de Programación y Seguimiento de Proyectos Estratégicos "C"', 10);
      nudgeAcr('SVAC', 40);
      nudgeAcr('EL', 10); nudgeName('Enlace Logístico', 10);

      const nodes = root.descendants();
      const links = root.links();
      const linkKey = d => d.target.id || (d.target.id = Math.random().toString(36).slice(2));

      const linkHalo = gLinksHalo.selectAll('path').data(links, linkKey);
      linkHalo.enter().append('path').attr('class','link-halo').attr('d', _ => elbow(source, source))
        .merge(linkHalo).transition().duration(420).attr('d', d => elbow(d.source, d.target));
      linkHalo.exit().transition().duration(250).attr('d', _ => elbow(source, source)).remove();

      const link = gLinks.selectAll('path').data(links, linkKey);
      link.enter().append('path').attr('class','link').attr('stroke', d => nodeColor(d.source)).attr('d', _ => elbow(source, source))
        .merge(link).transition().duration(420).attr('stroke', d => nodeColor(d.source)).attr('d', d => elbow(d.source, d.target));
      link.exit().transition().duration(250).attr('d', _ => elbow(source, source)).remove();

      const nodeSel = gNodes.selectAll('g.node').data(nodes, d=> d.id || (d.id = Math.random().toString(36).slice(2)));
      const enter = nodeSel.enter().append('g').attr('class','node').attr('transform', _ => `translate(${source.y0},${source.x0})`).style('opacity', 0)
        .on('click', (ev,d)=>{ toggle(d); update(d); });

      const card = enter.append('g').attr('class','node-card');
      card.append('rect').attr('class','node-rect');
      card.append('text').attr('class','node-title');
      card.append('text').attr('class','node-sub');
      card.append('path').attr('class','toggle');
      card.append('rect').attr('class','hit');

      const badge = card.append('g').attr('class','badge');
      badge.append('rect').attr('class','badge-bg');
      badge.append('text').attr('class','badge-text');
      const countG  = badge.append('g').attr('class','count-pill');
      countG.append('rect').attr('rx',7).attr('ry',7);
      countG.append('text').attr('class','count-tx');

      function refreshCard(g, d){
        const lines = wrap(g.select('.node-title'), (d.data.name||''), MAX_TEXT_W);
        const titleH = lines * 16;
        const rawAttr = d.data.atributos ?? d.data.atributo ?? '';
        const meta = Array.isArray(rawAttr) ? '' : (rawAttr || '').toString().trim();
        let subH = 0;
        if (meta){ g.select('.node-sub').text(meta).attr('x', PAD_X).attr('dy', 16); subH = 18; }
        else { g.select('.node-sub').text(''); }

        const kids = dataKidsCount(d);
        const acr = getAcr(d);
        g.select('.badge-text').text(acr);
        const acrTextW = Math.max(12, g.select('.badge-text').node().getComputedTextLength());
        let pillW = 0, pillH = 16;
        if (kids > 0){
          g.select('.count-pill').style('display', null);
          g.select('.count-tx').text(String(kids));
          const txtW = Math.max(7, g.select('.count-tx').node().getComputedTextLength());
          pillW = Math.max(16, txtW + 10);
        } else {
          g.select('.count-tx').text('');
          g.select('.count-pill').style('display','none');
        }
        const wAcr = Math.max(28, acrTextW + 12) + (kids>0 ? (pillW + 8) : 0);

        const attrs = getAtributosArrayFromData(d.data);
        const procs = getProcedimientosArrayFromData(d.data);

        let attrG = g.select('g.attr-badge');
        let procG = g.select('g.proc-badge');

        if (!attrG.empty()) attrG.selectAll('*').remove();
        if (!procG.empty()) procG.selectAll('*').remove();

        let wAttr = 0, wProc = 0;

        if (showToolBadges && attrs.length){
          if (attrG.empty()) attrG = g.append('g').attr('class','attr-badge').attr('tabindex',0);
          const labelAttr = `Atribuciones (${attrs.length})`;
          const tmpA = attrG.append('text').attr('font-size',11).attr('font-weight',700).text(labelAttr).attr('visibility','hidden');
          wAttr = Math.ceil(tmpA.node().getComputedTextLength()) + 14; tmpA.remove();
          attrG.append('rect').attr('width', wAttr).attr('height', 20);
          attrG.append('text').attr('x', wAttr/2).attr('y', 14).attr('text-anchor','middle').text(labelAttr);
        } else { if (!attrG.empty()) attrG.remove(); attrG = null; }

        if (showToolBadges && procs.length){
          if (procG.empty()) procG = g.append('g').attr('class','proc-badge').attr('tabindex',0);
          const labelProc = `Procedimientos (${procs.length})`;
          const tmpP = procG.append('text').attr('font-size',11).attr('font-weight',700).text(labelProc).attr('visibility','hidden');
          wProc = Math.ceil(tmpP.node().getComputedTextLength()) + 14; tmpP.remove();
          procG.append('rect').attr('width', wProc).attr('height', 20);
          procG.append('text').attr('x', wProc/2).attr('y', 14).attr('text-anchor','middle').text(labelProc);
        } else { if (!procG.empty()) procG.remove(); procG = null; }

        const gap = 6, marginSide = 8;
        const baseContentW = MAX_TEXT_W + PAD_X*2 + 32;
        let contentW = baseContentW;

        if (showToolBadges){
          const badgesTotal = (procG? wProc:0) + (attrG? ((procG?gap:0) + wAttr):0) + ((procG||attrG)?gap:0) + wAcr;
          const neededW = marginSide + badgesTotal + marginSide;
          contentW = Math.max(baseContentW, neededW);
        }

        const blockH = Math.max(48 + titleH + subH + 12, 54);

        g.select('.node-rect').attr('x', 0).attr('y', -blockH/2).attr('width', contentW).attr('height', blockH);
        g.select('.node-title').attr('x', PAD_X).attr('y', -blockH/2 + 48 + 12);
        if (meta){ g.select('.node-sub').attr('y', -blockH/2 + 48 + titleH + 12); }
        g.select('.hit').attr('x', -10).attr('y', -blockH/2 - 6).attr('width', contentW + 20).attr('height', blockH + 12);

        const by = -blockH/2 + 8;
        let bx = contentW - wAcr - marginSide;
        g.select('.badge-bg').attr('x', bx).attr('y', by).attr('width', wAcr).attr('height', 18);
        g.select('.badge-text').attr('x', bx + 6).attr('y', by + 13);

        if (kids > 0){
          const cx = bx + wAcr - pillW - 6;
          const cy = by + (18 - pillH)/2;
          g.select('.count-pill').attr('transform', `translate(${cx},${cy})`);
          g.select('.count-pill rect').attr('x',0).attr('y',0).attr('width', pillW).attr('height', pillH)
            .attr('fill', nodeColor(d)).attr('stroke','#fff').attr('stroke-width',1.2);
          g.select('.count-tx').attr('x', pillW/2).attr('y', pillH/2);
        }

        const cxToggle = contentW - 12, cyToggle = 0;
        const isOpen = Array.isArray(d.children) && d.children.length > 0;
        const path = isOpen ? `M ${cxToggle-6},${cyToggle-3} L ${cxToggle},${cyToggle+3} L ${cxToggle+6},${cyToggle-3} Z`
                            : `M ${cxToggle-6},${cyToggle+3} L ${cxToggle},${cyToggle-3} L ${cxToggle+6},${cyToggle+3} Z`;
        g.select('.toggle').attr('d', path);

        if (showToolBadges){
          let xAcr = bx;
          let xAttr = xAcr - (attrG ? (gap + (wAttr||0)) : 0);
          let xProc = xAttr - (procG ? (gap + (wProc||0)) : 0);

          if (procG && xProc < marginSide){
            const shift = marginSide - xProc;
            xProc += shift; xAttr += shift; xAcr += shift;
            bx = xAcr;
            g.select('.badge-bg').attr('x', xAcr);
            g.select('.badge-text').attr('x', xAcr + 6);
            if (kids > 0){
              const cx = xAcr + wAcr - pillW - 6;
              const cy = by + (18 - pillH)/2;
              g.select('.count-pill').attr('transform', `translate(${cx},${cy})`);
            }
          }
          if (procG) procG.attr('transform', `translate(${xProc},${by})`);
          if (attrG) attrG.attr('transform', `translate(${xAttr},${by})`);
        }

        function bindBadgeEvents(sel, type){
          if (!sel) return;
          const key = `${d.id}|${type}`;
          sel.attr('data-key', key)
            .on('mouseenter', (evt)=>{
              evt.stopPropagation();
              cancelHideTimer();
              if (!showToolBadges) return;
              if (pinned && !(pinned.id===d.id && pinned.type===type)) return;
              const html = (type==='attr') ? renderAtribucionesHTML(d.data) : renderProcedimientosHTML(d.data);
              setTooltip(html, evt.currentTarget, false);
            })
            .on('mouseleave', (evt)=>{
              evt.stopPropagation();
              if (pinned && pinned.id===d.id && pinned.type===type) return;
              scheduleHide(200);
            })
            .on('click', (evt)=>{
              evt.stopPropagation();
              if (!showToolBadges) return;
              const same = pinned && pinned.id===d.id && pinned.type===type;
              if (same){ clearPinned(); return; }
              pinned = { id:d.id, type };
              d3.selectAll('.attr-badge,.proc-badge').classed('pinned', false);
              d3.select(evt.currentTarget).classed('pinned', true);
              const html = (type==='attr') ? renderAtribucionesHTML(d.data) : renderProcedimientosHTML(d.data);
              setTooltip(html, evt.currentTarget, true);
            })
            .on('keydown', (evt)=>{
              if(evt.key==='Enter' || evt.key===' '){
                evt.preventDefault(); evt.stopPropagation();
                sel.dispatch('click', {bubbles:true, cancelable:true});
              }
            });
        }
        bindBadgeEvents(attrG, 'attr');
        bindBadgeEvents(procG, 'proc');

        d._box = { w: contentW, h: blockH };
      }

      enter.each(function(d){ refreshCard(d3.select(this).select('.node-card'), d); });
      const merged = enter.merge(nodeSel);
      merged.each(function(d){ refreshCard(d3.select(this).select('.node-card'), d); });

      merged.transition().duration(420).attr('transform', d => `translate(${d.y},${d.x})`).style('opacity', 1);
      nodeSel.exit().transition().duration(250).attr('transform', _ => `translate(${source.y},${source.x})`).style('opacity', 0).remove();

      root.descendants().forEach(d => { d.x0 = d.x; d.y0 = d.y; });

      if (!showToolBadges){ clearPinned(); hideTooltip(); }
      else if (pinned){
        const anchor = getBadgeEl(pinned.id, pinned.type);
        if (!anchor){ clearPinned(); }
        else { activeAnchorEl = anchor; followAnchor(); }
      } else if (tooltipVisible()){
        if (!activeAnchorEl || !document.contains(activeAnchorEl)) hideTooltip();
        else followAnchor();
      }
    }

    function expandAll(d=root){ d.children = d.children || d._children; d._children=null; if (d.children) d.children.forEach(expandAll); }
    function collapseAll(d=root){ if (d.children){ d._children = d.children; d.children = null; } if (d._children) d._children.forEach(collapseAll); }

    function fitToScreen(pad=60, saveHome=false){
      const bbox = gRoot.node().getBBox();
      const w = host.clientWidth, h = host.clientHeight;
      if (!bbox.width || !bbox.height) return;

      const scale = ZOOM_MIN;

      let tx = (w - bbox.width * scale)/2 - bbox.x * scale;
      tx += ORG_X_OFFSET;
      const ty = (h - bbox.height* scale)/2 - bbox.y * scale;

      const t = d3.zoomIdentity.translate(tx, ty).scale(scale);
      applyTransform(t);
      if (saveHome || !HOME) HOME = t;
      return t;
    }

    function goHome(){ if (HOME) applyTransform(HOME); else fitToScreen(60, true); }

    function focusOnKeepScale(d){
      const tr = d3.zoomTransform(svg.node());
      const k = tr.k;
      const w = host.clientWidth, h = host.clientHeight;
      const box = d._box || {w: 300, h: 60};
      const tx = w/2 - (d.y + box.w/2) * k + ORG_X_OFFSET;
      const ty = h/2 - (d.x) * k;
      applyTransform(d3.zoomIdentity.translate(tx, ty).scale(k), 450);
    }

    function panNodeIntoViewY(node, margin = 48){
      if (!node) return;
      const tr = d3.zoomTransform(svg.node());
      const k  = tr.k;
      const h  = host.clientHeight;
      const box = node._box || { w: 300, h: 60 };
      const nodeTop    = (node.x - box.h/2) * k + tr.y;
      const nodeBottom = (node.x + box.h/2) * k + tr.y;
      const above = nodeTop < margin;
      const below = nodeBottom > (h - margin);
      if (above || below){
        const targetY = Math.round(h/2 - (node.x * k));
        const t = d3.zoomIdentity.translate(tr.x, targetY).scale(k);
        applyTransform(t, 520);
      }
    }

    update(root);

    function autoFit(){
      let tries = 0, maxTries = 24;
      const tick = () => {
        const b = gRoot.node()?.getBBox?.();
        if (b && b.width > 0 && b.height > 0) {
          fitToScreen(60, true);
        } else if (tries++ < maxTries) {
          requestAnimationFrame(tick);
        } else {
          setTimeout(() => fitToScreen(60, true), 220);
        }
      };
      if (document.fonts?.ready) { document.fonts.ready.then(() => requestAnimationFrame(tick)); }
      else { requestAnimationFrame(tick); }
    }
    window.addEventListener('load', autoFit, { once: true });
    window.addEventListener('pageshow', () => autoFit());

    document.getElementById('btn-expand').onclick = ()=>{ expandAll(); update(root); setTimeout(()=>goHome(), 30); };
    document.getElementById('btn-collapse').onclick = ()=>{
      collapseAll(); root.children = root._children; root._children=null;
      clearPinned(); hideTooltip();
      update(root); setTimeout(()=>goHome(), 30);
    };

    // ===== Buscador =====
    const allNodes = (function flattenAll(node){
      const out = [];
      (function walk(n){ out.push(n); const kids = (n.children || n._children) || []; for (const k of kids) walk(k); })(node);
      return out;
    })(root);

    const indexAcr = new Map();
    const acroSetForList = new Set();
    for (const n of allNodes){
      const acr = (n?.data?.["acrónimo"] ?? n?.data?.["acronimo"] ?? "").toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').toUpperCase().trim();
      if (acr){ acroSetForList.add(acr); if (!indexAcr.has(acr)) indexAcr.set(acr, []); indexAcr.get(acr).push(n); }
    }

    function refreshDatalist(prefix){
      listEl.innerHTML = '';
      const q = (prefix || '').toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').toUpperCase().trim();
      if (!q) return;
      const items = Array.from(acroSetForList).filter(a => a.startsWith(q)).sort();
      for (const acr of items){
        const opt = document.createElement('option');
        opt.value = acr;
        listEl.appendChild(opt);
      }
    }
    inputEl.addEventListener('input', (e)=> refreshDatalist(e.target.value));

    function clearMatches(){
      d3.select('.nodes').selectAll('g.node').classed('is-match', false).classed('is-highlight', false);
      resultsEl.innerHTML = '';
    }

    function showResults(qRaw){
      clearMatches();
      const query = (qRaw || inputEl.value || '').toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').toUpperCase().trim();
      if (!query){ return; }

      let matches = [];
      if (indexAcr.has(query)) matches = matches.concat(indexAcr.get(query));
      if (matches.length === 0){
        for (const [acr, arr] of indexAcr){ if (acr.includes(query)) matches = matches.concat(arr); }
      }
      if (matches.length === 0){
        for (const n of allNodes){
          const nm = (n.data?.name || '').toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').toUpperCase().trim();
          if (nm && nm.includes(query)) matches.push(n);
        }
      }

      if (matches.length === 0){
        resultsEl.innerHTML = `<span class="chip">Sin resultados para <b>${query}</b></span>`;
        return;
      }

      matches.forEach(n => {
        let p = n.parent;
        while (p){ if (!p.children){ p.children = p._children; p._children = null; } p = p.parent; }
      });
      update(root);
      goHome();

      const seen = new Set(), unique = [];
      for (const n of matches){ if (!seen.has(n)) { seen.add(n); unique.push(n); } }

      const ids = new Set(unique.map(n => n.id));
      d3.select('.nodes').selectAll('g.node').classed('is-match', d => ids.has(d.id));

      resultsEl.innerHTML = '';
      unique.forEach((n, i) => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        const acr = (n?.data?.["acrónimo"] ?? n?.data?.["acronimo"] ?? "").toString().trim();
        chip.innerHTML = `<b>${acr || '—'}</b> · ${n.data.name}`;
        chip.onclick = () => focusOnKeepScale(n);
        resultsEl.appendChild(chip);
        if (i === 0) setTimeout(()=> chip.click(), 80);
      });

      const first = unique[0];
      d3.selectAll('g.node').classed('is-highlight', d => d === first);
      setTimeout(()=> d3.selectAll('g.node').classed('is-highlight', false), 3000);
      setTimeout(() => panNodeIntoViewY(first, 48), 460);
    }

    document.getElementById('btn-search').onclick = ()=> showResults();
    inputEl.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') showResults(); });
    document.getElementById('btn-clear').onclick = ()=>{ inputEl.value = ''; refreshDatalist(''); clearMatches(); goHome(); };

    const htmlEl  = document.documentElement;
    const btnInst = document.getElementById('btn-inst');
    const btnTips = document.getElementById('btn-tooltips');

    document.getElementById('btn-trenes')?.addEventListener('click', ()=> window.open('https://attrapi.github.io/trenes/', '_blank', 'noopener'));


    btnInst?.addEventListener('click', ()=>{
      const instOn = htmlEl.getAttribute('data-institutional') === 'on';
      htmlEl.setAttribute('data-institutional', instOn ? 'off' : 'on');
      document.getElementById('btn-inst').textContent = instOn ? 'Modo institucional' : 'Institucional: ON';
      update(root);
      setTimeout(()=> goHome(), 20);
    });

    btnTips?.addEventListener('click', ()=>{
      showToolBadges = !showToolBadges;
      btnTips.textContent = 'Atribuciones y Procedimientos';
      if (!showToolBadges){ clearPinned(); hideTooltip(); }
      update(root);
    });

    window.addEventListener('resize', followAnchor);
    window.addEventListener('scroll', followAnchor, true);

    async function exportPDF(){
      const el = document.getElementById('chart');
      const hint = document.querySelector('.hint');
      hint?.classList.add('no-export');

      const bg = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim() || '#ffffff';

      const canvas = await html2canvas(el, { backgroundColor: bg, scale: 2, useCORS: true, logging: false });
      const imgData = canvas.toDataURL('image/png');

      const { jsPDF } = window.jspdf;
      const orientation = canvas.width >= canvas.height ? 'l' : 'p';
      const pdf = new jsPDF({ orientation, unit: 'mm', format: 'a4' });

      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      pdf.setFont('helvetica','bold');
      pdf.setFontSize(14);
      const title = 'Organigrama · ATTRAPI';
      pdf.text(title, pageW/2, 12, { align: 'center' });

      const margin = 10, topGap = 8;
      const maxW = pageW - margin * 2;
      const maxH = pageH - margin * 2 - 8;

      const ratio = Math.min(maxW / canvas.width, (maxH - 10) / canvas.height);
      const drawW = canvas.width * ratio;
      const drawH = canvas.height * ratio;
      const x = (pageW - drawW) / 2;
      const y = 18 + topGap;

      pdf.addImage(imgData, 'PNG', x, y, drawW, drawH);

      const t = new Date();
      const pad = n => String(n).padStart(2, '0');
      const filename = `organigrama-ATTRAPI-${t.getFullYear()}${pad(t.getMonth()+1)}${pad(t.getDate())}-${pad(t.getHours())}${pad(t.getMinutes())}.pdf`;

      pdf.save(filename);

      hint?.classList.remove('no-export');
    }

    const btnDownload = document.getElementById('btn-download');
    btnDownload.addEventListener('click', async () => {
      try{
        btnDownload.classList.add('animating');
        await exportPDF();
      } catch (err){
        console.error('Error al exportar PDF:', err);
        alert('Ups, no pude generar el PDF. Revisa la consola para más detalle.');
      } finally {
        setTimeout(()=> btnDownload.classList.remove('animating'), 2300);
      }
    });

  })();
  </script>

  <!-- Librerías para exportar a PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- ============== AGENTE (Flowise) — esquina inferior derecha ============== -->
  <script>
  (function(){
    const brand = (getComputedStyle(document.documentElement).getPropertyValue('--brand') || '').trim() || '#691c32';

    const style = document.createElement('style');
    style.textContent = `
      .flowise-footer,
      .chat-window-footer,
      [data-testid="powered-by"],
      [aria-label*="Powered by"]{ display:none !important; }
      .chat-label{
        position: fixed; right: 82px; bottom: 30px;
        background: ${brand}; color:#fff; font:700 12px/1 ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial;
        padding: 8px 10px; border-radius: 999px; box-shadow: 0 8px 18px rgba(0,0,0,.18);
        pointer-events: none; z-index: 1000; white-space: nowrap;
      }
      @media (max-width: 640px){ .chat-label{ display:none !important; } }
    `;
    document.head.appendChild(style);

    function openAssistant() {
      try {
        if (typeof window.Chatbot?.open === 'function') { window.Chatbot.open(); }
        if (typeof window.Chatbot?.focus === 'function') { window.Chatbot.focus(); }
        if (typeof window.Chatbot?.open === 'function' || typeof window.Chatbot?.focus === 'function') {
          return true;
        }
      } catch(_) {}
      const sels = [
        '.chatbot-button',
        '[class*="chatbot-button"]',
        '[class*="launcher"]',
        'button[aria-label*="chat" i]',
        'button[aria-label*="asistente" i]'
      ];
      for (const sel of sels){
        const btn = document.querySelector(sel);
        if (btn){ btn.click(); return true; }
      }
      return false;
    }

    function openAssistantWithRetry() {
      let tries = 0;
      const iv = setInterval(() => {
        if (openAssistant() || ++tries > 30) clearInterval(iv);
      }, 150);
    }

    window.openAsistenteARTF = openAssistantWithRetry;

    window.addEventListener('DOMContentLoaded', () => {
      import('https://cdn.jsdelivr.net/npm/flowise-embed/dist/web.js')
        .then(mod => {
          const Chatbot = mod?.default || mod?.Chatbot || mod;
          window.Chatbot = Chatbot;

          Chatbot.init({
            chatflowid: '8f1072cf-0f9d-400e-974e-93d2c3ed6d3a',
            apiHost: 'https://daniel.fixtergeek.com',
            theme: {
              button: { backgroundColor: brand, right: 20, bottom: 20 },
              chatWindow: {
                title: 'Asistente ATTRAPI',
                showTitle: true,
                welcomeMessage: 'Hola 👋, ¿Dudas con el Organigrama? Pídeme ayuda.',
                userMessage: { backgroundColor: brand, textColor: '#fff' },
                textInput: {
                  placeholder: 'Escribe tu pregunta…',
                  sendButtonColor: brand,
                  autoFocus: true
                },
                footer: { text: '', company: '', companyLink: '' }
              },
              customCSS: `
                .flowise-footer,
                .chat-window-footer,
                [data-testid="powered-by"],
                [aria-label*="Powered by"]{
                  display: none !important;
                }
              `
            }
          });

          const label = document.createElement('div');
          label.className = 'chat-label';
          label.textContent = 'Abrir Asistente ATTRAPI';
          document.body.appendChild(label);

          window.addEventListener('keydown', (e) => {
            if (e.altKey && e.shiftKey && (e.key === 'A' || e.key === 'a')) {
              openAssistantWithRetry();
            }
          });
        })
        .catch(err => {
          console.error('Error cargando Flowise embed:', err);
        });
    });
  })();
  </script>
</body>
</html>






